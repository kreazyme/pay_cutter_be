{"version":3,"sources":["../../src/middlewares/auth.middleware.ts"],"sourcesContent":["import { NextFunction, Response } from 'express';\r\nimport { verify } from 'jsonwebtoken';\r\nimport { SECRET_KEY } from '@config';\r\nimport { UserEntity } from '@entities/users.entity';\r\nimport { HttpException } from '@exceptions/HttpException';\r\nimport { DataStoredInToken, RequestWithUser } from '@interfaces/auth.interface';\r\n\r\nconst getAuthorization = (req) => {\r\n  const coockie = req.cookies['Authorization'];\r\n  if (coockie) return coockie;\r\n\r\n  const header = req.header('Authorization');\r\n  if (header) return header.split('Bearer ')[1];\r\n\r\n  return null;\r\n}\r\n\r\nexport const AuthMiddleware = async (req: RequestWithUser, res: Response, next: NextFunction) => {\r\n  try {\r\n    const Authorization = getAuthorization(req);\r\n\r\n    if (Authorization) {\r\n      const { id } = (await verify(Authorization, SECRET_KEY)) as DataStoredInToken;\r\n      const findUser = await UserEntity.\r\n        createQueryBuilder('user')\r\n        .where('user.id = :id', { id })\r\n        .addSelect('user.password')\r\n        .getOne();\r\n\r\n      if (findUser) {\r\n        req.user = findUser;\r\n        next();\r\n      } else {\r\n        next(new HttpException(401, 'Wrong authentication token'));\r\n      }\r\n    } else {\r\n      next(new HttpException(404, 'Authentication token missing'));\r\n    }\r\n  } catch (error) {\r\n    next(new HttpException(401, 'Wrong authentication token'));\r\n  }\r\n};\r\n"],"names":["AuthMiddleware","getAuthorization","req","coockie","cookies","header","split","res","next","Authorization","id","verify","SECRET_KEY","findUser","UserEntity","createQueryBuilder","where","addSelect","getOne","user","HttpException","error"],"mappings":";;;;+BAiBaA;;aAAAA;;8BAhBU;wBACI;6BACA;+BACG;AAG9B,MAAMC,mBAAmB,CAACC,MAAQ;IAChC,MAAMC,UAAUD,IAAIE,OAAO,CAAC,gBAAgB;IAC5C,IAAID,SAAS,OAAOA;IAEpB,MAAME,SAASH,IAAIG,MAAM,CAAC;IAC1B,IAAIA,QAAQ,OAAOA,OAAOC,KAAK,CAAC,UAAU,CAAC,EAAE;IAE7C,OAAO,IAAI;AACb;AAEO,MAAMN,iBAAiB,OAAOE,KAAsBK,KAAeC,OAAuB;IAC/F,IAAI;QACF,MAAMC,gBAAgBR,iBAAiBC;QAEvC,IAAIO,eAAe;YACjB,MAAM,EAAEC,GAAE,EAAE,GAAI,MAAMC,IAAAA,oBAAM,EAACF,eAAeG,kBAAU;YACtD,MAAMC,WAAW,MAAMC,uBAAU,CAC/BC,kBAAkB,CAAC,QAClBC,KAAK,CAAC,iBAAiB;gBAAEN;YAAG,GAC5BO,SAAS,CAAC,iBACVC,MAAM;YAET,IAAIL,UAAU;gBACZX,IAAIiB,IAAI,GAAGN;gBACXL;YACF,OAAO;gBACLA,KAAK,IAAIY,4BAAa,CAAC,KAAK;YAC9B,CAAC;QACH,OAAO;YACLZ,KAAK,IAAIY,4BAAa,CAAC,KAAK;QAC9B,CAAC;IACH,EAAE,OAAOC,OAAO;QACdb,KAAK,IAAIY,4BAAa,CAAC,KAAK;IAC9B;AACF"}